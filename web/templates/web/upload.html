{% extends "web/base.html" %}
{% load static %}
{% block content %}
<div class="upload-main-title">Anomaly Detection</div>
<div class="upload-center-box">
  {% if error %}
    <p class="error">{{ error }}</p>
  {% endif %}
  <!-- 파일 업로드 및 칼럼 미리보기/제거 UI -->
  <form id="uploadForm" enctype="multipart/form-data" style="width:100%;">
    {% csrf_token %}
    <label for="datafile">Log File Upload</label>
    <div class="upload-file-input">
      <label class="upload-file-label" id="fileLabel" onclick="triggerFileInput()">Choose a file</label>
      <input type="file" name="datafile" id="datafile" accept=".log,.txt,.csv,.xlsx" required style="display:none;">
    </div>
    <div class="upload-desc">
      * Please <b>.log, .txt, .csv, .xlsx</b> file
    </div>
    <!-- 칼럼 미리보기/제거 UI -->
    <div id="preview" style="margin:1rem 0;"></div>
    <div id="columns"></div>
    <button type="submit" class="upload-btn" style="display:block;">Upload & Analyze</button>
  </form>
</div>
<div class="upload-footer">
  &copy; 2025. 이상無조 All rights reserved.
</div>
<style>
  .upload-main-title {
    font-size: 2.4rem;
    font-weight: 700;
    color: #3a465e;
    text-align: center;
    margin-top: 2.5rem;
    margin-bottom: 2.5rem;
    letter-spacing: -1px;
  }
  .upload-center-box {
    background: #fff;
    border-radius: 20px;
    box-shadow: 0 4px 24px rgba(0,0,0,0.08);
    max-width: 420px;
    margin: 0 auto;
    padding: 2.5rem 2rem 2rem 2rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    border: 1.5px solid #e0e3e8;
  }
  .upload-center-box label {
    font-size: 1.2rem;
    font-weight: 600;
    color: #3a465e;
    margin-bottom: 1rem;
    display: block;
    text-align: center;
  }
  .upload-file-input {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1.2rem;
    width: 100%;
    justify-content: center;
  }
  .upload-file-label {
    background: #f5f6fa;
    border: 1.5px solid #cfd8dc;
    border-radius: 8px;
    padding: 0.8rem 1.2rem;
    font-size: 1.1rem;
    color: #495057;
    cursor: pointer;
    transition: border 0.2s;
    width: 260px;
    text-align: center;
  }
  .upload-file-label:hover {
    border: 1.5px solid #007bff;
    color: #007bff;
  }
  .upload-desc {
    font-size: 0.95rem;
    color: #888;
    margin-bottom: 1.5rem;
    text-align: center;
  }
  .upload-btn {
    background: #0a357d;
    color: #fff;
    border: none;
    border-radius: 8px;
    font-size: 1.2rem;
    font-weight: 600;
    padding: 0.9rem 0;
    width: 100%;
    margin-top: 1.2rem;
    cursor: pointer;
    transition: background 0.2s;
  }
  .upload-btn:hover {
    background: #174fa3;
  }
  .error {
    color: #dc3545;
    margin-bottom: 1rem;
    text-align: center;
  }
  .upload-footer {
    text-align: right;
    color: #888;
    font-size: 0.95rem;
    margin-top: 2.5rem;
    margin-right: 2.5rem;
  }
</style>
<script>
  // CSRF 토큰 가져오기 함수
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  function triggerFileInput() {
    document.getElementById('datafile').click();
  }
  document.getElementById('datafile').onchange = function() {
    const label = document.getElementById('fileLabel');
    if (this.files.length > 0) {
      label.textContent = this.files[0].name;
      const file = this.files[0];
      const formData = new FormData();
      formData.append("file", file);
      fetch("{% url 'web:preview_columns' %}", {
        method: "POST",
        body: formData,
        headers: {'X-CSRFToken': csrftoken}
      })
        .then(r => r.json())
        .then(data => {
          let html = "<b>제외할 칼럼 선택:</b><br>";
          data.columns.forEach(col => {
            html += `<label style='margin-right:8px;'><input type="checkbox" name="exclude" value="${col}"> ${col}</label>`;
          });
          document.getElementById('columns').innerHTML = html;
          let table = "<table border='1' style='margin-top:10px;'><tr>";
          data.columns.forEach(col => table += `<th>${col}</th>`);
          table += "</tr>";
          data.preview.forEach(row => {
            table += "<tr>";
            data.columns.forEach(col => table += `<td>${row[col]}</td>`);
            table += "</tr>";
          });
          table += "</table>";
          document.getElementById('preview').innerHTML = table;
          document.querySelector('.upload-btn').style.display = "block";
        });
    } else {
      label.textContent = "Choose a file";
      document.getElementById('preview').innerHTML = "";
      document.getElementById('columns').innerHTML = "";
      document.querySelector('.upload-btn').style.display = "none";
    }
  };

  document.getElementById('uploadForm').onsubmit = function(e) {
    e.preventDefault();
    const file = document.getElementById('datafile').files[0];
    const formData = new FormData();
    formData.append("file", file);
    const exclude = [...document.querySelectorAll('input[name="exclude"]:checked')].map(cb => cb.value);
    formData.append("exclude_columns", exclude.join(","));
    fetch("{% url 'web:detect_anomalies' %}", {
      method: "POST",
      body: formData,
      headers: {'X-CSRFToken': csrftoken}
    })
      .then(r => r.json())
      .then(data => {
        alert("분석 완료! 대시보드에서 결과를 확인하세요.");
        window.location.href = "{% url 'web:dashboard' %}";
      });
  };
</script>
{% endblock %}